# 02.5. Lambda ì „í™˜ (Employee Service)

**ì†Œìš” ì‹œê°„**: 2ì‹œê°„  
**ëª©í‘œ**: Employee Serviceë¥¼ EKS â†’ Lambda ì „í™˜ (ë¹„ìš© 21% ì ˆê°)

---

## ğŸ“Š í˜„ì¬ ìƒí™© ë¶„ì„

### í˜„ì¬ êµ¬ì¡° (ëª¨ë‘ EKS)

```
API Gateway (ë‹¨ì¼ ì§„ì…ì )
  â”œâ”€ /api/employees/*     â†’ VPC Link â†’ NLB â†’ Employee Pods (2ê°œ)
  â”œâ”€ /api/approvals/*     â†’ VPC Link â†’ NLB â†’ Approval Pods (4ê°œ)
  â””â”€ /api/notifications/* â†’ VPC Link â†’ NLB â†’ Notification Pods (2ê°œ)

ì´ 8 Pods
ë¹„ìš©: $82.30/ì›”
```

**ë¬¸ì œ:**
- âŒ Employee ServiceëŠ” ê°„ë‹¨í•œ CRUD (MySQLë§Œ)
- âŒ ì‹¤í–‰ ì‹œê°„ 200ms (Lambda ì í•©)
- âŒ EKS Pod 2ê°œ ë¶ˆí•„ìš” (ë¹„ìš© ë‚­ë¹„)

### ì™œ Employee Serviceë§Œ Lambdaë¡œ?

**Lambda ì „í™˜ ê°€ëŠ¥ ì¡°ê±´ ë¶„ì„:**

| ì„œë¹„ìŠ¤ | ì‹¤í–‰ ì‹œê°„ | ì˜ì¡´ì„± | Lambda ê°€ëŠ¥? | ì´ìœ  |
|--------|----------|--------|-------------|------|
| **Employee** | 200ms | MySQLë§Œ | âœ… **ê°€ëŠ¥** | ê°„ë‹¨í•œ CRUD, ë¹ ë¥¸ ì‘ë‹µ |
| Approval Request | 500ms | MongoDB, Kafka Producer | âŒ ë¶ˆê°€ | Kafka ì˜ì¡´ì„± |
| Approval Processing | ì¥ì‹œê°„ | Kafka Consumer | âŒ ë¶ˆê°€ | 15ë¶„ ì œí•œ ì´ˆê³¼ |
| Notification | ì¥ì‹œê°„ | WebSocket ì—°ê²° ìœ ì§€ | âŒ ë¶ˆê°€ | ìš”ì²­-ì‘ë‹µ ëª¨ë¸ |

**ì‹¤ì œ ì½”ë“œ í™•ì¸:**
```java
// backend/employee-service/src/main/java/com/erp/employee/EmployeeController.java
@RestController
@RequestMapping("/employees")
public class EmployeeController {
    @GetMapping
    public List<Employee> getAllEmployees() {
        return employeeService.findAll();  // ë‹¨ìˆœ ì¡°íšŒ
    }
    
    @PostMapping
    public Employee createEmployee(@RequestBody Employee employee) {
        return employeeService.save(employee);  // ë‹¨ìˆœ ì €ì¥
    }
}
```

**íŠ¹ì§•:**
- âœ… ê°„ë‹¨í•œ CRUD ì‘ì—…
- âœ… MySQLë§Œ ì‚¬ìš© (RDS ì—°ê²°)
- âœ… Kafka, WebSocket ì—†ìŒ
- âœ… í‰ê·  ì‹¤í–‰ ì‹œê°„ 200ms

---

## ğŸ¯ ê°œì„  ëª©í‘œ

### After (Employee â†’ Lambda)

```
API Gateway (ë‹¨ì¼ ì§„ì…ì )
  â”œâ”€ /api/employees/*     â†’ Lambda (ì§ì ‘ í†µí•©) âœ… VPC Link ë¶ˆí•„ìš”
  â”œâ”€ /api/approvals/*     â†’ VPC Link â†’ NLB â†’ Approval Pods (4ê°œ)
  â””â”€ /api/notifications/* â†’ VPC Link â†’ NLB â†’ Notification Pods (2ê°œ)

ì´ 6 Pods + Lambda
ë¹„ìš©: $61.73 (EKS) + $3 (Lambda) = $64.73/ì›”
ì ˆê°: $17.57/ì›” (21%)
```

**ì¥ì :**
- âœ… ë¹„ìš© 21% ì ˆê°
- âœ… ìë™ ìŠ¤ì¼€ì¼ë§ (ë™ì‹œ ì‹¤í–‰ 1000ê°œ)
- âœ… VPC Link ë¶ˆí•„ìš” (Lambda ì§ì ‘ í†µí•©)
- âœ… Cold Start 300~500ms (ì²« ìš”ì²­ë§Œ)

---

## ğŸš€ Step 1: Terraform Lambda ëª¨ë“ˆ ìƒì„± (40ë¶„)

### 1-1. í´ë” ìƒì„±

```bash
cd infrastructure/terraform/dev
mkdir -p erp-dev-Lambda
cd erp-dev-Lambda
```

### 1-2. main.tf ìƒì„±

```bash
cat > main.tf << 'EOF'
terraform {
  required_version = ">= 1.0"
  
  backend "s3" {
    bucket         = "erp-terraform-state-subin-bucket"
    key            = "dev/lambda/terraform.tfstate"
    region         = "ap-northeast-2"
    dynamodb_table = "erp-terraform-locks"
    encrypt        = true
  }
  
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = var.region
}

# Remote State ì°¸ì¡°
data "terraform_remote_state" "vpc" {
  backend = "s3"
  config = {
    bucket = "erp-terraform-state-subin-bucket"
    key    = "dev/vpc/subnet/terraform.tfstate"
    region = "ap-northeast-2"
  }
}

data "terraform_remote_state" "security_groups" {
  backend = "s3"
  config = {
    bucket = "erp-terraform-state-subin-bucket"
    key    = "dev/security-groups/eks-sg/terraform.tfstate"
    region = "ap-northeast-2"
  }
}

data "terraform_remote_state" "rds" {
  backend = "s3"
  config = {
    bucket = "erp-terraform-state-subin-bucket"
    key    = "dev/databases/rds/terraform.tfstate"
    region = "ap-northeast-2"
  }
}

data "terraform_remote_state" "api_gateway" {
  backend = "s3"
  config = {
    bucket = "erp-terraform-state-subin-bucket"
    key    = "dev/api-gateway/terraform.tfstate"
    region = "ap-northeast-2"
  }
}

# Lambda Security Group
resource "aws_security_group" "lambda" {
  name        = "${var.project_name}-${var.environment}-lambda-sg"
  description = "Security group for Lambda functions"
  vpc_id      = data.terraform_remote_state.vpc.outputs.vpc_id

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "${var.project_name}-${var.environment}-lambda-sg"
  }
}

# Lambda IAM Role
resource "aws_iam_role" "lambda" {
  name = "${var.project_name}-${var.environment}-lambda-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect = "Allow"
      Principal = {
        Service = "lambda.amazonaws.com"
      }
      Action = "sts:AssumeRole"
    }]
  })
}

# Lambda VPC Execution Policy
resource "aws_iam_role_policy_attachment" "lambda_vpc" {
  role       = aws_iam_role.lambda.name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
}

# Lambda Secrets Manager Policy
resource "aws_iam_role_policy" "lambda_secrets" {
  role = aws_iam_role.lambda.id
  name = "lambda-secrets-policy"

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect = "Allow"
      Action = [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
      ]
      Resource = "arn:aws:secretsmanager:${var.region}:${var.account_id}:secret:prod/*"
    }]
  })
}

# ECR Repository (Lambda ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ìš©)
resource "aws_ecr_repository" "employee_lambda" {
  name                 = "${var.project_name}/employee-service-lambda"
  image_tag_mutability = "MUTABLE"

  image_scanning_configuration {
    scan_on_push = true
  }

  tags = {
    Name = "${var.project_name}-employee-service-lambda"
  }
}

# Lambda Function (ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€)
resource "aws_lambda_function" "employee" {
  function_name = "${var.project_name}-${var.environment}-employee-service"
  role          = aws_iam_role.lambda.arn
  
  package_type = "Image"
  image_uri    = "${aws_ecr_repository.employee_lambda.repository_url}:latest"
  
  vpc_config {
    subnet_ids         = data.terraform_remote_state.vpc.outputs.private_subnet_ids
    security_group_ids = [aws_security_group.lambda.id]
  }
  
  environment {
    variables = {
      SPRING_DATASOURCE_URL = "jdbc:mysql://${data.terraform_remote_state.rds.outputs.endpoint}:3306/erp?useSSL=true"
    }
  }
  
  memory_size = 512
  timeout     = 30
  
  tags = {
    Name = "${var.project_name}-${var.environment}-employee-service"
  }
}

# Lambda Permission (API Gateway í˜¸ì¶œ í—ˆìš©)
resource "aws_lambda_permission" "api_gateway" {
  statement_id  = "AllowAPIGatewayInvoke"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.employee.function_name
  principal     = "apigateway.amazonaws.com"
  source_arn    = "${data.terraform_remote_state.api_gateway.outputs.api_gateway_execution_arn}/*/*"
}

# API Gateway Integration (Lambda ì§ì ‘ í†µí•©)
resource "aws_apigatewayv2_integration" "employee_lambda" {
  api_id             = data.terraform_remote_state.api_gateway.outputs.api_gateway_id
  integration_type   = "AWS_PROXY"
  integration_method = "POST"
  integration_uri    = aws_lambda_function.employee.invoke_arn
  payload_format_version = "2.0"
}

# API Gateway Route (ê¸°ì¡´ NLB ë¼ìš°íŠ¸ ëŒ€ì²´)
resource "aws_apigatewayv2_route" "employee_proxy" {
  api_id    = data.terraform_remote_state.api_gateway.outputs.api_gateway_id
  route_key = "ANY /api/employees/{proxy+}"
  target    = "integrations/${aws_apigatewayv2_integration.employee_lambda.id}"
}

resource "aws_apigatewayv2_route" "employee_root" {
  api_id    = data.terraform_remote_state.api_gateway.outputs.api_gateway_id
  route_key = "ANY /api/employees"
  target    = "integrations/${aws_apigatewayv2_integration.employee_lambda.id}"
}
EOF
```

### 1-3. variables.tf ìƒì„±

```bash
cat > variables.tf << 'EOF'
variable "project_name" {
  default = "erp"
}

variable "environment" {
  default = "dev"
}

variable "region" {
  default = "ap-northeast-2"
}

variable "account_id" {
  default = "806332783810"
}
EOF
```

### 1-4. outputs.tf ìƒì„±

```bash
cat > outputs.tf << 'EOF'
output "lambda_function_arn" {
  value = aws_lambda_function.employee.arn
}

output "lambda_function_name" {
  value = aws_lambda_function.employee.function_name
}

output "ecr_repository_url" {
  value = aws_ecr_repository.employee_lambda.repository_url
}
EOF
```

---

## ğŸ³ Step 2: Lambdaìš© Dockerfile ìƒì„± (20ë¶„)

### 2-1. Dockerfile.lambda ìƒì„±

```bash
cd /mnt/c/Users/Lethe/Desktop/ì·¨ì—…ì¤€ë¹„/erp-project/backend/employee-service

cat > Dockerfile.lambda << 'EOF'
FROM public.ecr.aws/lambda/java:17

# JAR íŒŒì¼ ë³µì‚¬
COPY target/employee-service-1.0.0.jar ${LAMBDA_TASK_ROOT}/app.jar

# Lambda Handler ì„¤ì •
CMD ["org.springframework.cloud.function.adapter.aws.FunctionInvoker::handleRequest"]
EOF
```

### 2-2. pom.xmlì— Lambda ì˜ì¡´ì„± ì¶”ê°€

```bash
# pom.xml ìˆ˜ì •
cat >> pom.xml << 'EOF'

<!-- Lambda ì˜ì¡´ì„± ì¶”ê°€ -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-function-adapter-aws</artifactId>
    <version>4.0.0</version>
</dependency>
EOF
```

---

## ğŸ“ Step 3: Helm Chartì—ì„œ Employee Service ì œê±° (10ë¶„)

### 3-1. values-dev.yaml ìˆ˜ì •

```bash
cd /mnt/c/Users/Lethe/Desktop/ì·¨ì—…ì¤€ë¹„/erp-project/helm-chart

# values-dev.yamlì—ì„œ employee ì„¹ì…˜ ë¹„í™œì„±í™”
cat > values-dev.yaml << 'EOF'
namespace: erp-dev

# ... (ê¸°ì¡´ ë‚´ìš©)

services:
  # employee:  # â† Lambdaë¡œ ì „í™˜, ì£¼ì„ ì²˜ë¦¬
  #   enabled: false
  
  approvalRequest:
    enabled: true
    # ... (ê¸°ì¡´ ë‚´ìš©)
  
  approvalProcessing:
    enabled: true
    # ... (ê¸°ì¡´ ë‚´ìš©)
  
  notification:
    enabled: true
    # ... (ê¸°ì¡´ ë‚´ìš©)
EOF
```

---

## ğŸ”§ Step 4: Terraform ë°°í¬ (20ë¶„)

### 4-1. Terraform ì´ˆê¸°í™” ë° ë°°í¬

```bash
cd infrastructure/terraform/dev/erp-dev-Lambda

# ì´ˆê¸°í™”
terraform init

# ê³„íš í™•ì¸
terraform plan

# ë°°í¬
terraform apply -auto-approve
```

**ìƒì„± ë¦¬ì†ŒìŠ¤:**
- Lambda Function (employee-service)
- Lambda IAM Role
- Lambda Security Group
- ECR Repository (employee-service-lambda)
- API Gateway Integration (Lambda ì§ì ‘ í†µí•©)
- API Gateway Routes (/api/employees, /api/employees/{proxy+})

**í™•ì¸:**
```bash
terraform output

# ì˜ˆìƒ ì¶œë ¥:
# lambda_function_arn = "arn:aws:lambda:ap-northeast-2:806332783810:function:erp-dev-employee-service"
# ecr_repository_url = "806332783810.dkr.ecr.ap-northeast-2.amazonaws.com/erp/employee-service-lambda"
```

---

## ğŸš€ Step 5: Lambda ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬ (20ë¶„)

### 5-1. Lambda ì´ë¯¸ì§€ ë¹Œë“œ

```bash
cd backend/employee-service

# Maven ë¹Œë“œ
mvn clean package -DskipTests

# Lambdaìš© Docker ì´ë¯¸ì§€ ë¹Œë“œ
docker build -f Dockerfile.lambda -t employee-service-lambda:latest .

# ECR ë¡œê·¸ì¸
aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 806332783810.dkr.ecr.ap-northeast-2.amazonaws.com

# ì´ë¯¸ì§€ íƒœê·¸
docker tag employee-service-lambda:latest 806332783810.dkr.ecr.ap-northeast-2.amazonaws.com/erp/employee-service-lambda:latest

# ECR í‘¸ì‹œ
docker push 806332783810.dkr.ecr.ap-northeast-2.amazonaws.com/erp/employee-service-lambda:latest
```

### 5-2. Lambda í•¨ìˆ˜ ì—…ë°ì´íŠ¸

```bash
# Lambda í•¨ìˆ˜ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
aws lambda update-function-code \
  --function-name erp-dev-employee-service \
  --image-uri 806332783810.dkr.ecr.ap-northeast-2.amazonaws.com/erp/employee-service-lambda:latest \
  --region ap-northeast-2

# ì—…ë°ì´íŠ¸ ì™„ë£Œ ëŒ€ê¸°
aws lambda wait function-updated \
  --function-name erp-dev-employee-service \
  --region ap-northeast-2
```

---

## âœ… Step 6: ê²€ì¦ (10ë¶„)

### 6-1. Lambda í•¨ìˆ˜ í™•ì¸

```bash
# Lambda í•¨ìˆ˜ ìƒíƒœ í™•ì¸
aws lambda get-function \
  --function-name erp-dev-employee-service \
  --region ap-northeast-2 \
  --query 'Configuration.[FunctionName,State,LastUpdateStatus]' \
  --output table

# ì˜ˆìƒ ì¶œë ¥:
# --------------------------------
# |  GetFunction                 |
# +------------------------------+
# |  erp-dev-employee-service    |
# |  Active                      |
# |  Successful                  |
# +------------------------------+
```

### 6-2. API Gateway í…ŒìŠ¤íŠ¸

```bash
# Employee Service í…ŒìŠ¤íŠ¸ (Lambda í˜¸ì¶œ)
curl https://mqi4qaw3bb.execute-api.ap-northeast-2.amazonaws.com/api/employees

# ì˜ˆìƒ ì¶œë ¥:
# [
#   {
#     "id": 1,
#     "name": "í™ê¸¸ë™",
#     "email": "hong@erp.com",
#     "department": "DEVELOPMENT"
#   },
#   ...
# ]
```

### 6-3. Lambda ë¡œê·¸ í™•ì¸

```bash
# CloudWatch Logs í™•ì¸
aws logs tail /aws/lambda/erp-dev-employee-service \
  --follow \
  --region ap-northeast-2
```

### 6-4. EKSì—ì„œ Employee Service ì œê±° í™•ì¸

```bash
# Employee Service Podê°€ ì—†ì–´ì•¼ í•¨
kubectl get pods -n erp-dev | grep employee

# ì¶œë ¥ ì—†ìŒ (ì •ìƒ)

# Serviceë„ ì—†ì–´ì•¼ í•¨
kubectl get svc -n erp-dev | grep employee

# ì¶œë ¥ ì—†ìŒ (ì •ìƒ)
```

---

## ğŸ“Š ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Terraform Lambda ëª¨ë“ˆ ìƒì„±
- [ ] Dockerfile.lambda ìƒì„±
- [ ] pom.xmlì— Lambda ì˜ì¡´ì„± ì¶”ê°€
- [ ] Helm Chartì—ì„œ employee ì œê±°
- [ ] Terraform apply ì„±ê³µ
- [ ] Lambda ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
- [ ] Lambda í•¨ìˆ˜ ì—…ë°ì´íŠ¸
- [ ] API Gateway í…ŒìŠ¤íŠ¸ ì„±ê³µ
- [ ] Lambda ë¡œê·¸ í™•ì¸
- [ ] EKSì—ì„œ Employee Pod ì œê±° í™•ì¸

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

**Lambda ì „í™˜ ì™„ë£Œ!**

**ë‹¤ìŒ íŒŒì¼ì„ ì½ìœ¼ì„¸ìš”:**
â†’ **03_SECRETS_SETUP.md**

```bash
cd /mnt/c/Users/Lethe/Desktop/ì·¨ì—…ì¤€ë¹„/erp-project/re_build
cat 03_SECRETS_SETUP.md
```

---

## ğŸ“ˆ ê°œì„  íš¨ê³¼

### Before (ëª¨ë‘ EKS)

```
ì´ 8 Pods:
- Employee: 2 Pods
- Approval Request: 2 Pods
- Approval Processing: 2 Pods
- Notification: 2 Pods

ë¹„ìš©: $82.30/ì›”
```

### After (Employee â†’ Lambda)

```
ì´ 6 Pods:
- Approval Request: 2 Pods
- Approval Processing: 2 Pods
- Notification: 2 Pods

Lambda:
- Employee Service (100,000 ìš”ì²­/ì›”)

ë¹„ìš©: $61.73 (EKS) + $3 (Lambda) = $64.73/ì›”
ì ˆê°: $17.57/ì›” (21%)
```

### API Gateway ë¼ìš°íŒ…

```
API Gateway (ë‹¨ì¼ ì§„ì…ì )
  â”œâ”€ /api/employees/*     â†’ Lambda (ì§ì ‘ í†µí•©) âœ…
  â”œâ”€ /api/approvals/*     â†’ VPC Link â†’ NLB â†’ EKS
  â””â”€ /api/notifications/* â†’ VPC Link â†’ NLB â†’ EKS
```

**ì¥ì :**
- VPC Link ë¶ˆí•„ìš” (Lambda ì§ì ‘ í†µí•©)
- Cold Start 300~500ms (ì²« ìš”ì²­ë§Œ)
- ìë™ ìŠ¤ì¼€ì¼ë§ (ë™ì‹œ ì‹¤í–‰ 1000ê°œ)

---

## ğŸ” ì£¼ì˜ì‚¬í•­

### Cold Start

**ì²« ìš”ì²­:**
- 300~500ms (ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”)

**ì´í›„ ìš”ì²­:**
- 50~100ms (ì •ìƒ)

**í•´ê²°:**
- Provisioned Concurrency (ì¶”ê°€ ë¹„ìš©)
- ë˜ëŠ” Cold Start í—ˆìš© (ê°œë°œ í™˜ê²½)

### RDS ì—°ê²°

**Lambda â†’ RDS:**
- VPC ë‚´ë¶€ í†µì‹ 
- Security Group ì„¤ì • í•„ìš”
- Connection Pool ìµœì í™” í•„ìš”

---

**"Employee Serviceë¥¼ Lambdaë¡œ ì „í™˜í–ˆìŠµë‹ˆë‹¤. ë¹„ìš© 21% ì ˆê°!"**
