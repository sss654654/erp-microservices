# Network Policy는 Calico CNI 설치 후 적용 가능
# 설치: kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml

---
# 1. 기본 거부 (Default Deny All)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: default
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# 2. Employee Service → RDS + 내부 통신
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: employee-service-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: employee-service
  policyTypes:
  - Egress
  egress:
  # 같은 Namespace 내부 통신 (Approval Request, Notification)
  - to:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 8082
    - protocol: TCP
      port: 8084
  # RDS MySQL
  - ports:
    - protocol: TCP
      port: 3306
  # DNS
  - ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53

---
# 3. Approval Request Service → MongoDB + gRPC
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: approval-request-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: approval-request-service
  policyTypes:
  - Egress
  egress:
  # 같은 Namespace 내부 통신 (Approval Processing gRPC)
  - to:
    - podSelector:
        matchLabels:
          app: approval-processing-service
    ports:
    - protocol: TCP
      port: 9090
  # Employee Service
  - to:
    - podSelector:
        matchLabels:
          app: employee-service
    ports:
    - protocol: TCP
      port: 8081
  # Notification Service
  - to:
    - podSelector:
        matchLabels:
          app: notification-service
    ports:
    - protocol: TCP
      port: 8084
  # MongoDB Atlas (외부)
  - ports:
    - protocol: TCP
      port: 27017
  # DNS
  - ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53

---
# 4. Approval Processing Service → gRPC
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: approval-processing-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: approval-processing-service
  policyTypes:
  - Egress
  egress:
  # Approval Request Service (gRPC)
  - to:
    - podSelector:
        matchLabels:
          app: approval-request-service
    ports:
    - protocol: TCP
      port: 9091
  # DNS
  - ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53

---
# 5. Notification Service → Redis
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: notification-policy
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: notification-service
  policyTypes:
  - Egress
  egress:
  # ElastiCache Redis
  - ports:
    - protocol: TCP
      port: 6379
  # DNS
  - ports:
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53

---
# 6. ALB → 모든 서비스 Ingress 허용
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-alb
  namespace: default
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 8081
    - protocol: TCP
      port: 8082
    - protocol: TCP
      port: 8083
    - protocol: TCP
      port: 8084
